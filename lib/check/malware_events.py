from datetime import datetime, timedelta, UTC
from libprobe.asset import Asset
from libprobe.check import Check
from ..query import query_multi
from ..utils import str_to_timestamp


class CheckMalwareEvents(Check):
    key = 'malwareEvents'
    unchanged_eol = 14400

    @staticmethod
    async def run(asset: Asset, local_config: dict, config: dict) -> dict:

        max_age_days = config.get('malwareMaxAge', 7)
        after = datetime.now(UTC) - timedelta(days=max_age_days)
        req = '/malwareDetection/events'
        params = {
            'limit': 2000,
            'detectedAfterTimeUtcFilter': after.isoformat()
        }
        results = await query_multi(asset, local_config, config, req, params)
        malware_events = []
        for result in results:
            malware_events.append({
                'name': result['id'],  # str (id)
                'type': result['type'],  # str
                'detectionTimeUtc':
                    str_to_timestamp(result['detectionTimeUtc']),  # int
                'machineUuid': result.get('machine', {}).get('uuid'),  # str
                'machineName':
                    result.get('machine', {}).get('displayName'),  # str
                'machineBackupObjectId':
                    result.get('machine', {}).get('backupObjectId'),  # str
                'state': result['state'],  # str
                'details': result['details'],  # str
                'source': result['source'],  # str
                'severity': result['severity'],  # str
                'createdBy': result['createdBy'],  # str
                'engine': result['engine'],  # str
            })

        return {
            'malwareEvents': malware_events,
        }
